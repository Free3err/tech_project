# RelayBot - Руководство пользователя

**Версия:** 1.0  
**Дата:** 09.02.2026

---

## Содержание

1. [Введение](#введение)
2. [Требования к оборудованию](#требования-к-оборудованию)
3. [Установка системы](#установка-системы)
4. [Калибровка](#калибровка)
5. [Запуск системы](#запуск-системы)
6. [Мониторинг работы](#мониторинг-работы)
7. [Устранение неполадок](#устранение-неполадок)
8. [Обслуживание](#обслуживание)

---

## Введение

RelayBot - это автономная система доставки посылок на базе Raspberry Pi. Робот самостоятельно:
- Обнаруживает клиентов в зоне доставки
- Проверяет заказы через QR-коды
- Забирает посылки на складе
- Доставляет посылки клиентам
- Возвращается в домашнюю позицию

### Основные возможности

- **Автономная навигация** с использованием LiDAR и одометрии
- **Обнаружение людей** для безопасного взаимодействия
- **Проверка заказов** через QR-коды и базу данных
- **Голосовые подсказки** на русском языке
- **Автоматическое восстановление** после ошибок

---

## Требования к оборудованию

### Основные компоненты

1. **Raspberry Pi 4** (рекомендуется 4GB RAM)
2. **Arduino Uno** или совместимая плата
3. **LiDAR LDROBOT D500** (дальность до 10 метров)
4. **Камера** для сканирования QR-кодов (USB или Pi Camera)
5. **Моторы постоянного тока** с энкодерами (2 шт)
6. **Драйвер моторов** (L298N или аналог)
7. **Сервопривод** для механизма коробки
8. **ИК-датчик расстояния** для экстренной остановки
9. **Светодиоды** для индикации состояния
10. **Аккумулятор** (рекомендуется 12V, минимум 5000mAh)

### Механическая конструкция

- **База колес:** 25 см (настраивается в config.py)
- **Радиус колес:** 5 см (настраивается в config.py)
- **Коробка для посылок** с сервоприводом для открытия/закрытия
- **Крепление для LiDAR** на высоте 20-30 см от пола
- **Крепление для камеры** с обзором вперед

---

## Установка системы

### Быстрая установка

Для автоматической установки используйте скрипт:

```bash
chmod +x install.sh
sudo ./install.sh
```

Скрипт автоматически:
- Установит все зависимости Python
- Настроит базу данных
- Создаст необходимые директории
- Настроит systemd сервис для автозапуска
- Проверит подключение оборудования

### Ручная установка

Если автоматическая установка не работает:

#### 1. Установка зависимостей

```bash
# Обновление системы
sudo apt update
sudo apt upgrade -y

# Установка Python и pip
sudo apt install python3 python3-pip -y

# Установка системных библиотек
sudo apt install portaudio19-dev python3-opencv -y

# Установка Python пакетов
pip3 install -r requirements.txt
```

#### 2. Настройка базы данных

```bash
# База данных создается автоматически при первом запуске
# Убедитесь что директория assets/ существует
mkdir -p assets/audio assets/maps
```

#### 3. Настройка портов

Отредактируйте `config.py`:

```python
# Порт Arduino (найдите свой порт)
ARDUINO_PORT = '/dev/ttyACM0'  # или /dev/ttyUSB0

# Порт LiDAR
LIDAR_PORT = '/dev/ttyUSB0'  # или /dev/ttyUSB1
```

Для определения портов:
```bash
ls /dev/tty*
# Подключите устройство и снова выполните команду
# Новый порт - это ваше устройство
```

#### 4. Права доступа к портам

```bash
# Добавление пользователя в группы для доступа к портам
sudo usermod -a -G dialout $USER
sudo usermod -a -G tty $USER

# Перезагрузка для применения изменений
sudo reboot
```

---

## Калибровка

### 1. Калибровка колес

Измерьте параметры вашего робота и обновите `config.py`:

```python
# Расстояние между центрами колес (метры)
WHEEL_BASE = 0.25  # Измерьте ваше значение

# Радиус колеса (метры)
WHEEL_RADIUS = 0.05  # Измерьте ваше значение

# Тики энкодера на один оборот
ENCODER_TICKS_PER_REVOLUTION = 360  # Проверьте спецификацию энкодера
```

**Как измерить:**
- **WHEEL_BASE:** Расстояние между центрами левого и правого колес
- **WHEEL_RADIUS:** Радиус колеса (диаметр / 2)
- **ENCODER_TICKS:** Смотрите документацию вашего энкодера

### 2. Калибровка энкодеров

Проверьте направление вращения энкодеров:

```bash
# Запустите тестовую программу
python3 test_data.py
```

Робот должен двигаться вперед. Если движется назад, поменяйте провода моторов или измените направление в Arduino коде.

### 3. Позиционирование LiDAR

- Установите LiDAR на высоте **20-30 см** от пола
- Направьте вперед (0° = направление движения робота)
- Убедитесь что обзор не перекрыт конструкцией робота
- LiDAR должен видеть на 360°

### 4. Калибровка камеры

- Установите камеру с обзором вперед
- Высота: 30-50 см от пола
- Угол: слегка вниз (10-15°) для лучшего сканирования QR-кодов
- Проверьте фокус на расстоянии 30-50 см

### 5. Создание карты окружения

Отредактируйте `assets/maps/warehouse_map.yaml`:

```yaml
# Размеры карты (метры)
width: 10.0
height: 10.0
resolution: 0.05  # метров на пиксель

# Домашняя позиция (начало координат)
origin: [0.0, 0.0]

# Зона склада (координаты загрузки)
warehouse_zone: [5.0, 3.0]

# Препятствия (стены, стеллажи)
obstacles:
  - type: wall
    points: [[0, 0], [10, 0], [10, 10], [0, 10], [0, 0]]
  
  - type: shelf
    points: [[2, 2], [3, 2], [3, 4], [2, 4], [2, 2]]
```

**Рекомендации:**
- Используйте систему координат с началом в домашней позиции робота
- Добавьте все стационарные препятствия
- Оставьте зазор 30 см от препятствий для безопасной навигации

### 6. Настройка скорости моторов

Отрегулируйте скорость в `config.py`:

```python
# Максимальная скорость (0-255)
MAX_SPEED = 150  # Начните с 150, увеличивайте постепенно

# Минимальная скорость для движения
MIN_SPEED = 50  # Минимум для преодоления трения
```

**Тестирование:**
1. Начните с MAX_SPEED = 100
2. Проверьте плавность движения
3. Увеличивайте на 25 пока не достигнете желаемой скорости
4. Не превышайте 200 для безопасности

---

## Запуск системы

### Ручной запуск

```bash
# Переход в директорию проекта
cd /path/to/relaybot

# Запуск системы
python3 main.py
```

### Автоматический запуск (systemd)

После установки система настроена на автозапуск:

```bash
# Проверка статуса
sudo systemctl status relaybot

# Запуск
sudo systemctl start relaybot

# Остановка
sudo systemctl stop relaybot

# Перезапуск
sudo systemctl restart relaybot

# Отключение автозапуска
sudo systemctl disable relaybot

# Включение автозапуска
sudo systemctl enable relaybot
```

### Первый запуск

При первом запуске система:
1. Инициализирует базу данных
2. Проверит подключение к Arduino
3. Подключится к LiDAR
4. Загрузит карту окружения
5. Перейдет в состояние WAITING

**Проверьте логи:**
```bash
tail -f relaybot.log
```

Вы должны увидеть:
```
Все подсистемы успешно инициализированы!
Машина состояний инициализирована в состоянии WAITING
```

---

## Мониторинг работы

### Логи системы

Система создает несколько файлов логов:

- **relaybot.log** - Главный лог всей системы
- **state_machine.log** - Логи машины состояний
- **navigation.log** - Логи навигации
- **lidar.log** - Логи LiDAR
- **serial.log** - Логи связи с Arduino
- **audio.log** - Логи аудио системы
- **box.log** - Логи контроллера коробки
- **qr_scanner.log** - Логи QR сканера

**Просмотр логов в реальном времени:**
```bash
# Главный лог
tail -f relaybot.log

# Навигация
tail -f navigation.log

# Машина состояний
tail -f state_machine.log
```

### Индикация состояний (LED)

Робот использует светодиоды для индикации состояния:

- **LED_IDLE** (мигание) - Ожидание клиента (WAITING)
- **LED_MOVING** (бегущий огонь) - Движение (APPROACHING, NAVIGATING, RETURNING, RESETTING)
- **LED_WAITING** (постоянное свечение) - Ожидание действия (VERIFYING, LOADING, DELIVERING)
- **LED_ERROR** (быстрое мигание) - Ошибка (ERROR_RECOVERY, EMERGENCY_STOP)

### Звуковые сигналы

Робот использует голосовые подсказки на русском:

- **"Пожалуйста, покажите QR код вашего заказа"** - Запрос QR кода
- **"Заказ принят. Еду на склад."** - Заказ подтвержден
- **"Заказ не найден. Пожалуйста, проверьте QR код."** - Заказ отклонен
- **"Ваш заказ доставлен. Приятного дня!"** - Доставка завершена
- **"Заказ номер X"** - Объявление номера заказа на складе

### Цикл доставки

Нормальный цикл доставки:

1. **WAITING** - Робот в домашней позиции, ожидает клиента
2. **APPROACHING** - Обнаружен клиент, робот подъезжает
3. **VERIFYING** - Сканирование и проверка QR кода
4. **NAVIGATING_TO_WAREHOUSE** - Движение к складу
5. **LOADING** - Ожидание загрузки посылки (нажмите Enter)
6. **RETURNING_TO_CUSTOMER** - Возврат к клиенту
7. **DELIVERING** - Доставка посылки (10 секунд)
8. **RESETTING** - Возврат домой
9. Возврат к шагу 1

---

## Устранение неполадок

### Робот не запускается

**Проблема:** Ошибка при запуске main.py

**Решения:**
1. Проверьте подключение Arduino:
   ```bash
   ls /dev/ttyACM* /dev/ttyUSB*
   ```
2. Проверьте права доступа:
   ```bash
   sudo chmod 666 /dev/ttyACM0
   ```
3. Проверьте логи:
   ```bash
   cat relaybot.log
   ```

### LiDAR не подключается

**Проблема:** "Не удалось подключить LiDAR"

**Решения:**
1. Проверьте порт в config.py
2. Проверьте питание LiDAR (5V)
3. Проверьте скорость передачи (230400 для D500)
4. Попробуйте другой USB порт

### Камера не работает

**Проблема:** QR коды не сканируются

**Решения:**
1. Проверьте подключение камеры:
   ```bash
   ls /dev/video*
   ```
2. Проверьте фокус камеры
3. Улучшите освещение
4. Проверьте качество QR кода (минимум 3x3 см)

### Робот не движется

**Проблема:** Моторы не вращаются

**Решения:**
1. Проверьте питание моторов (12V)
2. Проверьте подключение драйвера моторов
3. Проверьте Arduino код загружен
4. Проверьте serial.log для команд моторов

### Неточная навигация

**Проблема:** Робот промахивается мимо цели

**Решения:**
1. Откалибруйте WHEEL_BASE и WHEEL_RADIUS
2. Проверьте энкодеры (test_data.py)
3. Улучшите карту окружения
4. Настройте PID коэффициенты в config.py

### Робот застревает

**Проблема:** Робот останавливается и не может продолжить

**Решения:**
1. Проверьте препятствия на карте
2. Увеличьте OBSTACLE_CLEARANCE в config.py
3. Проверьте LiDAR на загрязнение
4. Проверьте логи navigation.log

### Ошибка базы данных

**Проблема:** "Заказ не найден" для всех QR кодов

**Решения:**
1. Проверьте файл assets/orders.db существует
2. Добавьте тестовые заказы:
   ```bash
   python3 test_data.py
   ```
3. Проверьте формат QR кода (JSON с полем "order_id")

### Экстренная остановка

**Проблема:** Робот перешел в EMERGENCY_STOP

**Решения:**
1. Проверьте логи для причины:
   ```bash
   grep "EMERGENCY" relaybot.log
   ```
2. Устраните причину ошибки
3. Перезапустите систему:
   ```bash
   sudo systemctl restart relaybot
   ```

---

## Обслуживание

### Ежедневное обслуживание

- Проверьте заряд аккумулятора
- Очистите LiDAR от пыли
- Проверьте работу камеры
- Проверьте механизм коробки

### Еженедельное обслуживание

- Проверьте крепление всех компонентов
- Проверьте состояние колес
- Очистите энкодеры
- Проверьте все соединения проводов

### Ежемесячное обслуживание

- Обновите программное обеспечение
- Создайте резервную копию базы данных:
  ```bash
  ./backup.sh
  ```
- Проверьте калибровку
- Проверьте износ механических частей

### Резервное копирование

Автоматическое резервное копирование:
```bash
# Создание резервной копии
./backup.sh

# Восстановление из резервной копии
./backup.sh restore backup_2026-02-09.tar.gz
```

Резервные копии сохраняются в `backups/` и включают:
- База данных
- Конфигурация
- Карты
- Логи

---

## Контакты и поддержка

Для получения технической поддержки:
- Проверьте документацию в `docs/`
- Изучите логи системы
- Обратитесь к разработчику

**Версия документа:** 1.0  
**Последнее обновление:** 09.02.2026
