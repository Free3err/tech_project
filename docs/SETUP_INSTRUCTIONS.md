# RelayBot - Инструкция по установке и настройке

**Версия:** 1.0  
**Дата:** 09.02.2026

---

## Быстрый старт

### 1. Подготовка оборудования

**Подключите к Raspberry Pi:**
- Arduino Uno через USB
- LiDAR LDROBOT D500 через USB
- USB камеру для QR кодов
- Питание (12V для моторов, 5V для Raspberry Pi)

**Проверьте подключения:**
```bash
# Последовательные порты
ls /dev/tty{ACM,USB}*

# Камера
ls /dev/video*
```

### 2. Автоматическая установка

```bash
# Клонирование репозитория (если нужно)
git clone <repository_url>
cd relaybot

# Запуск установки
chmod +x install.sh
sudo ./install.sh

# Перезагрузка для применения прав доступа
sudo reboot
```

### 3. Настройка конфигурации

После перезагрузки отредактируйте `config.py`:

```python
# Порты (найдите свои порты командой: ls /dev/tty*)
ARDUINO_PORT = '/dev/ttyACM0'  # Ваш порт Arduino
LIDAR_PORT = '/dev/ttyUSB0'    # Ваш порт LiDAR

# Параметры робота (измерьте ваши значения)
WHEEL_BASE = 0.25      # Расстояние между колесами (м)
WHEEL_RADIUS = 0.05    # Радиус колеса (м)
ENCODER_TICKS_PER_REVOLUTION = 360  # Тики энкодера

# Координаты зон (настройте под ваше помещение)
HOME_POSITION = (0.0, 0.0)
WAREHOUSE_ZONE = (5.0, 3.0)
```

### 4. Создание карты

Отредактируйте `assets/maps/warehouse_map.yaml`:

```yaml
width: 10.0
height: 10.0
resolution: 0.05

origin: [0.0, 0.0]
warehouse_zone: [5.0, 3.0]

obstacles:
  - type: wall
    points: [[0, 0], [10, 0], [10, 10], [0, 10], [0, 0]]
```

### 5. Генерация аудио файлов

```bash
# Установка gTTS для генерации речи
pip3 install gtts

# Генерация аудио файлов
python3 generate_audio_files.py
```

### 6. Загрузка Arduino кода

```bash
# Откройте Arduino IDE
# Загрузите ideal_program.ino на Arduino
# Проверьте что скорость порта 9600
```

### 7. Тестирование

```bash
# Запуск тестов
python3 -m pytest tests/unit/ -v

# Тест производительности
python3 test_performance.py

# Тест данных (проверка моторов и энкодеров)
python3 test_data.py
```

### 8. Запуск системы

```bash
# Ручной запуск (для тестирования)
python3 main.py

# Или через systemd
sudo systemctl start relaybot

# Проверка статуса
sudo systemctl status relaybot

# Просмотр логов
tail -f relaybot.log
```

### 9. Автозапуск

```bash
# Включение автозапуска при загрузке
sudo systemctl enable relaybot

# Отключение автозапуска
sudo systemctl disable relaybot
```

---

## Калибровка

### Измерение параметров робота

**WHEEL_BASE (расстояние между колесами):**
1. Измерьте расстояние между центрами левого и правого колес
2. Обновите значение в `config.py`

**WHEEL_RADIUS (радиус колеса):**
1. Измерьте диаметр колеса
2. Разделите на 2 для получения радиуса
3. Обновите значение в `config.py`

**ENCODER_TICKS_PER_REVOLUTION:**
1. Проверьте документацию вашего энкодера
2. Обычно 360 или 400 тиков на оборот
3. Обновите значение в `config.py`

### Проверка направления моторов

```bash
python3 test_data.py
```

Робот должен двигаться вперед. Если движется назад:
- Поменяйте провода моторов местами
- Или измените направление в Arduino коде

### Настройка скорости

Начните с консервативных значений:

```python
MAX_SPEED = 100  # Начальное значение
MIN_SPEED = 50
```

Постепенно увеличивайте MAX_SPEED до желаемой скорости (не более 200).

### Настройка PID

Если робот движется неточно, настройте PID коэффициенты:

```python
# Линейная скорость
PID_LINEAR_KP = 1.0   # Увеличить для более быстрой реакции
PID_LINEAR_KD = 0.1   # Увеличить для уменьшения колебаний

# Угловая скорость
PID_ANGULAR_KP = 2.0  # Обычно выше чем линейный
PID_ANGULAR_KD = 0.2
```

---

## Создание карты окружения

### Измерение помещения

1. Выберите начало координат (домашняя позиция робота)
2. Измерьте размеры помещения
3. Отметьте расположение препятствий (стены, стеллажи)
4. Отметьте зону склада (где загружаются посылки)

### Формат карты

```yaml
# Размеры карты
width: 10.0   # Ширина в метрах
height: 10.0  # Высота в метрах
resolution: 0.05  # Разрешение (5 см на пиксель)

# Начало координат
origin: [0.0, 0.0]

# Зона склада
warehouse_zone: [5.0, 3.0]

# Препятствия
obstacles:
  # Внешние стены
  - type: wall
    points: [[0, 0], [10, 0], [10, 10], [0, 10], [0, 0]]
  
  # Стеллаж
  - type: shelf
    points: [[2, 2], [3, 2], [3, 4], [2, 4], [2, 2]]
  
  # Колонна
  - type: column
    center: [5, 5]
    radius: 0.3
```

### Советы по созданию карты

- Используйте зазор 30 см от препятствий
- Добавляйте только стационарные препятствия
- Динамические препятствия обнаруживаются LiDAR
- Проверьте что все пути проходимы

---

## Добавление заказов в базу данных

### Через Python

```python
from db.db import Session
from db.db_models import Order

session = Session()

# Создание заказа
order = Order(
    order_id=1,
    customer_name="Иван Иванов",
    items="Посылка 1",
    status="pending"
)
session.add(order)
session.commit()
```

### Через test_data.py

```bash
# Добавляет тестовые заказы
python3 test_data.py
```

---

## Устранение проблем при установке

### Ошибка: "Permission denied" для портов

```bash
# Добавьте пользователя в группы
sudo usermod -a -G dialout $USER
sudo usermod -a -G tty $USER

# Перезагрузите систему
sudo reboot
```

### Ошибка: "No module named 'cv2'"

```bash
# Установите OpenCV
sudo apt install python3-opencv
```

### Ошибка: "Could not find LiDAR"

1. Проверьте подключение LiDAR
2. Проверьте порт: `ls /dev/ttyUSB*`
3. Обновите LIDAR_PORT в config.py
4. Проверьте питание LiDAR (5V)

### Ошибка: "Arduino not responding"

1. Проверьте подключение Arduino
2. Проверьте порт: `ls /dev/ttyACM*`
3. Обновите ARDUINO_PORT в config.py
4. Загрузите ideal_program.ino на Arduino
5. Проверьте скорость порта (9600)

### Ошибка: "Camera not found"

1. Проверьте подключение камеры
2. Проверьте устройство: `ls /dev/video*`
3. Проверьте права доступа: `sudo chmod 666 /dev/video0`

---

## Проверка установки

### Чеклист

- [ ] Raspberry Pi загружается
- [ ] Arduino подключен и отвечает
- [ ] LiDAR подключен и сканирует
- [ ] Камера работает
- [ ] Моторы вращаются в правильном направлении
- [ ] Энкодеры считают тики
- [ ] Сервопривод открывает/закрывает коробку
- [ ] Аудио файлы воспроизводятся
- [ ] База данных содержит заказы
- [ ] Карта окружения создана
- [ ] Все тесты проходят
- [ ] Логи пишутся корректно

### Команды проверки

```bash
# Проверка портов
ls /dev/tty{ACM,USB}* /dev/video*

# Проверка Python пакетов
pip3 list

# Проверка базы данных
ls -l assets/orders.db

# Проверка карты
cat assets/maps/warehouse_map.yaml

# Проверка аудио файлов
ls assets/audio/*.wav

# Проверка сервиса
sudo systemctl status relaybot

# Проверка логов
tail -20 relaybot.log
```

---

## Следующие шаги

После успешной установки:

1. **Прочитайте USER_GUIDE.md** - Руководство пользователя
2. **Прочитайте DEVELOPER_GUIDE.md** - Руководство разработчика
3. **Выполните калибровку** - Настройте параметры робота
4. **Протестируйте в безопасной зоне** - Проверьте навигацию
5. **Создайте резервную копию** - `./backup.sh`

---

**Версия документа:** 1.0  
**Последнее обновление:** 09.02.2026
