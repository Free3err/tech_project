# Тесты RelayBot

Эта директория содержит все тесты для системы автономной доставки RelayBot.

## Структура

```
tests/
├── unit/           # Модульные тесты для отдельных компонентов
├── property/       # Property-based тесты с использованием Hypothesis
├── integration/    # Интеграционные тесты для полной системы
├── conftest.py     # Общие фикстуры pytest и настройки
└── README.md       # Этот файл
```

## Типы тестов

### Модульные тесты (unit/)

Модульные тесты проверяют отдельные компоненты системы с конкретными примерами и граничными случаями:

- Конкретные примеры правильного поведения
- Граничные случаи (пустые входы, граничные значения, условия ошибок)
- Точки интеграции между компонентами
- Обработка ошибок

**Примеры:**
- `test_state_machine.py` - тесты машины состояний
- `test_navigation.py` - тесты системы навигации
- `test_lidar_interface.py` - тесты интерфейса LiDAR
- `test_odometry.py` - тесты системы одометрии

### Property-based тесты (property/)

Property-based тесты проверяют универсальные свойства системы на случайных входных данных:

- Минимум 100 итераций на тест
- Проверка свойств корректности из документа дизайна
- Автоматическое обнаружение граничных случаев
- Использование библиотеки Hypothesis

**Формат тегов:**
```python
# Feature: relaybot-autonomous-delivery, Property N: <текст свойства>
```

**Примеры:**
- `test_navigation_properties.py` - свойства навигации
- `test_state_machine_properties.py` - свойства машины состояний
- `test_order_verification_properties.py` - свойства проверки заказов

### Интеграционные тесты (integration/)

Интеграционные тесты проверяют полную систему с реальным или mock оборудованием:

- Полный цикл доставки
- Восстановление после ошибок
- Интеграция с оборудованием
- Производительность системы

**Примеры:**
- `test_full_delivery_cycle.py` - полный цикл доставки
- `test_error_recovery.py` - восстановление после ошибок
- `test_hardware_integration.py` - интеграция с оборудованием

## Запуск тестов

### Все тесты
```bash
pytest tests/
```

### Только модульные тесты
```bash
pytest tests/unit/
```

### Только property-based тесты
```bash
pytest tests/property/
```

### Только интеграционные тесты
```bash
pytest tests/integration/
```

### С подробным выводом
```bash
pytest tests/ -v
```

### С покрытием кода
```bash
pytest tests/ --cov=. --cov-report=html
```

## Фикстуры

Файл `conftest.py` содержит общие фикстуры для всех тестов:

### Фикстуры базы данных
- `test_db_engine` - временная база данных в памяти
- `test_db_session` - сессия базы данных для каждого теста
- `test_db_with_data` - база данных с тестовыми данными

### Mock объекты
- `mock_serial` - mock последовательной связи с Arduino
- `mock_lidar` - mock LiDAR сенсора
- `mock_odometry` - mock системы одометрии
- `mock_audio` - mock аудио системы

### Тестовые данные
- `valid_qr_data` - валидные данные QR кода
- `valid_qr_json` - валидный JSON QR кода
- `invalid_qr_data` - невалидные данные QR кода
- `test_positions` - тестовые позиции для навигации
- `test_map_file` - временный файл карты

### Настройки Hypothesis
- `hypothesis_settings` - настройки для property-based тестов

## Вспомогательные функции

- `create_test_customer()` - создать тестового клиента в БД
- `create_test_order()` - создать тестовый заказ в БД

## Требования

Все необходимые зависимости указаны в `requirements.txt`:

```
hypothesis>=6.0.0
pytest>=7.0.0
numpy>=2.0.0
scipy>=1.7.0
```

## Рекомендации

1. **Пишите минимальные тесты** - избегайте избыточного тестирования
2. **Используйте property-based тесты** для проверки универсальных свойств
3. **Используйте модульные тесты** для конкретных примеров и граничных случаев
4. **Не используйте моки для обхода тестов** - тесты должны проверять реальную функциональность
5. **Запускайте тесты часто** - при каждом изменении кода
6. **Стремитесь к покрытию >80%** - но не жертвуйте качеством ради количества

## Отладка

Для отладки конкретного теста:

```bash
pytest tests/unit/test_example.py::test_specific_function -v -s
```

Флаги:
- `-v` - подробный вывод
- `-s` - показать print() вывод
- `-x` - остановиться на первой ошибке
- `--pdb` - запустить отладчик при ошибке

## Документация

Каждый тест должен содержать:
- Docstring с описанием того, что тестируется
- Комментарии на русском языке
- Ссылку на требование из спецификации (если применимо)
- Для property-based тестов: тег с номером свойства

Пример:

```python
def test_navigation_to_home():
    """
    Тест навигации к домашней позиции
    Проверяет, что робот может вернуться в точку (0,0)
    
    Requirements: 1.1, 8.2
    """
    # Тест...
```
